<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Week 3 Interactive Python Labs</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:0}
    header{padding:14px 16px;border-bottom:1px solid #ddd;display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    main{display:grid;grid-template-columns:1.05fr 1.35fr 1fr;gap:12px;padding:12px;height:calc(100vh - 62px);box-sizing:border-box}
    .card{border:1px solid #ddd;border-radius:12px;padding:12px;overflow:auto}
    h2{font-size:16px;margin:0 0 8px}
    textarea{width:100%;height:54vh;resize:vertical;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:14px;line-height:1.35;padding:10px;border-radius:12px;border:1px solid #ccc;box-sizing:border-box}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    button{padding:9px 12px;border:1px solid #ccc;background:#fff;border-radius:12px;cursor:pointer}
    button.primary{border-color:#111}
    button:disabled{opacity:.6;cursor:not-allowed}
    select{padding:8px 10px;border-radius:12px;border:1px solid #ccc}
    .pill{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid #ddd}
    .ok{border-color:#22c55e;color:#166534;background:#dcfce7}
    .bad{border-color:#ef4444;color:#7f1d1d;background:#fee2e2}
    .muted{color:#666;font-size:13px}
    #output{white-space:pre-wrap;background:#fafafa;border:1px solid #eee;border-radius:12px;padding:10px;min-height:140px}
    input{padding:10px;border:1px solid #ccc;border-radius:12px;width:100%;box-sizing:border-box}
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center}
    .modal{width:min(560px,92vw);background:#fff;border-radius:16px;padding:16px;border:1px solid #ddd}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .tiny{font-size:12px;color:#777}
    pre{white-space:pre-wrap}
    .scoreline{display:flex;justify-content:space-between;gap:10px;padding:6px 0;border-bottom:1px solid #f0f0f0}
    .scoreline:last-child{border-bottom:0}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    hr{border:none;border-top:1px solid #eee;margin:12px 0}
  </style>
</head>
<body>
<header>
  <strong>Week 3 Interactive Python Labs</strong>
  <span class="muted">Feedback + hints ‚Ä¢ Runs in your browser</span>

  <label class="muted" style="margin-left:10px;">Lab:</label>
  <select id="labSelect"></select>

  <span id="status" class="pill">Loading Python‚Ä¶</span>
  <span id="quickTotal" class="pill" style="margin-left:auto;">Total: ‚Äî</span>
</header>

<main>
  <section class="card">
    <h2>Student</h2>
    <div class="muted" id="studentInfo">Not signed in</div>
    <div class="row" style="margin-top:10px;">
      <button id="editStudentBtn">Edit Name/ID</button>
      <button id="clearWorkBtn">Clear My Saved Work</button>
    </div>

    <hr />
    <h2>Instructions</h2>
    <div id="instructions" class="muted"></div>

    <hr />
    <h2>Scores</h2>
    <div id="scoreBoard" class="muted">Click <b>Grade All</b> to calculate.</div>
    <div class="tiny" style="margin-top:10px;">
      Your code auto-saves per lab on this device.
    </div>
  </section>

  <section class="card">
    <div class="row" style="justify-content:space-between;">
      <h2>Code</h2>
      <div class="row">
        <button id="loadBtn">Load Starter</button>
        <button id="runBtn" class="primary">Run Code</button>
        <button id="checkBtn" class="primary">Check ‚úÖ</button>
        <button id="gradeBtn" class="primary">Grade All üßÆ</button>
      </div>
    </div>

    <textarea id="editor" spellcheck="false"></textarea>

    <div class="row">
      <span class="muted">Tip: If you get stuck, read ‚ÄúHow to Fix‚Äù.</span>
      <span id="autosaveStatus" class="pill">Autosave: on</span>
    </div>
  </section>

  <section class="card">
    <h2>Output</h2>
    <div id="output"></div>

    <hr />
    <h2>Result</h2>
    <div id="result" class="muted">Run your code, then press Check.</div>

    <hr />
    <h2>How to Fix</h2>
    <div id="helpBox" class="muted">If you fail a check, steps to fix will appear here.</div>
  </section>
</main>

<!-- Student modal -->
<div id="modal" class="modal-backdrop" style="display:none;">
  <div class="modal">
    <h3 style="margin:0 0 10px 0;">Enter Student Information</h3>
    <div class="grid2">
      <div>
        <div class="muted">Full Name</div>
        <input id="nameInput" placeholder="First Last" />
      </div>
      <div>
        <div class="muted">Student ID</div>
        <input id="idInput" placeholder="A00000000" />
      </div>
    </div>
    <div class="row" style="margin-top:12px; justify-content:flex-end;">
      <button id="saveStudentBtn" class="primary">Save</button>
    </div>
    <div class="tiny" style="margin-top:10px;">Required for Grade All.</div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/pyodide/v0.26.2/full/pyodide.js"></script>

<script>
  // ---------- DOM ----------
  const labSelect = document.getElementById("labSelect");
  const editor = document.getElementById("editor");
  const outputEl = document.getElementById("output");
  const resultEl = document.getElementById("result");
  const instructionsEl = document.getElementById("instructions");
  const statusEl = document.getElementById("status");
  const studentInfoEl = document.getElementById("studentInfo");
  const helpBox = document.getElementById("helpBox");
  const scoreBoard = document.getElementById("scoreBoard");
  const quickTotal = document.getElementById("quickTotal");
  const autosaveStatus = document.getElementById("autosaveStatus");

  const loadBtn = document.getElementById("loadBtn");
  const runBtn = document.getElementById("runBtn");
  const checkBtn = document.getElementById("checkBtn");
  const gradeBtn = document.getElementById("gradeBtn");
  const editStudentBtn = document.getElementById("editStudentBtn");
  const clearWorkBtn = document.getElementById("clearWorkBtn");

  const modal = document.getElementById("modal");
  const nameInput = document.getElementById("nameInput");
  const idInput = document.getElementById("idInput");
  const saveStudentBtn = document.getElementById("saveStudentBtn");

  let pyodide = null;
  let currentLabId = null;

  // ---------- UTIL ----------
  function setStatus(text, kind="") {
    statusEl.textContent = text;
    statusEl.className = "pill " + kind;
  }
  function escapeHtml(str) {
    return String(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }
  function showWhitespace(s) {
    return String(s).replace(/\r\n/g,"\n").replace(/ /g,"¬∑").replace(/\t/g,"‚Üí").replace(/\n/g,"‚èé\n");
  }
  function setHelp(title, steps, expected=null, got=null, hintLevelText=null) {
    let html = `<div style="font-weight:bold;margin-bottom:6px;">${escapeHtml(title)}</div>`;
    html += "<ol style='margin:0;padding-left:18px;'>";
    for (const step of steps) html += `<li>${step}</li>`;
    html += "</ol>";
    if (hintLevelText) html += `<div class="tiny" style="margin-top:10px;">${hintLevelText}</div>`;
    if (expected!==null && got!==null) {
      html += `
        <div style="margin-top:10px;">
          <div style="font-weight:bold;">Compare (spaces/newlines shown)</div>
          <div style="margin-top:6px;"><b>Expected:</b></div>
          <pre style="background:#fafafa;border:1px solid #eee;border-radius:12px;padding:10px;">${escapeHtml(showWhitespace(expected))}</pre>
          <div style="margin-top:6px;"><b>Got:</b></div>
          <pre style="background:#fafafa;border:1px solid #eee;border-radius:12px;padding:10px;">${escapeHtml(showWhitespace(got))}</pre>
        </div>`;
    }
    helpBox.innerHTML = html;
  }
  function clearHelp() {
    helpBox.textContent = "‚úÖ Nice work. If you fail a check, steps to fix will appear here.";
  }

  // ---------- STUDENT ----------
  function getStudent() {
    return {
      name: localStorage.getItem("lab_name") || "",
      studentId: localStorage.getItem("lab_studentId") || ""
    };
  }
  function setStudent(name, studentId) {
    localStorage.setItem("lab_name", name);
    localStorage.setItem("lab_studentId", studentId);
    renderStudent();
  }
  function renderStudent() {
    const s = getStudent();
    if (!s.name || !s.studentId) {
      studentInfoEl.innerHTML = `<span class="pill bad">Missing</span> Please enter your Name + Student ID.`;
    } else {
      studentInfoEl.innerHTML = `<span class="pill ok">Ready</span> <b>${escapeHtml(s.name)}</b> ‚Äî <b>${escapeHtml(s.studentId)}</b>`;
    }
  }
  function showModal(){ modal.style.display="flex"; }
  function hideModal(){ modal.style.display="none"; }

  // ---------- STORAGE ----------
  function codeKey(labId){ return `code_${labId}`; }
  function triesKey(labId){ return `tries_${labId}`; }
  function getSavedCode(labId){ return localStorage.getItem(codeKey(labId)) || ""; }
  function setSavedCode(labId, code){ localStorage.setItem(codeKey(labId), code); }
  function getTries(labId){ return parseInt(localStorage.getItem(triesKey(labId)) || "0", 10); }
  function incTries(labId){ localStorage.setItem(triesKey(labId), String(getTries(labId)+1)); }
  function resetTries(labId){ localStorage.setItem(triesKey(labId), "0"); }

  // ---------- PYODIDE ----------
  async function initPyodide() {
    setStatus("Loading Python‚Ä¶");
    try{
      pyodide = await loadPyodide();
      setStatus("Python ready", "ok");
      runBtn.disabled=false; checkBtn.disabled=false; gradeBtn.disabled=false;
    }catch(e){
      setStatus("Python failed to load", "bad");
      outputEl.textContent = "Pyodide did not load. If you opened this as file://, host it on GitHub Pages or use http://localhost.\n\nError:\n" + String(e);
    }
  }

  // Return JSON string from Python => reliable JS parse
  async function runPythonCapture(studentCode, testCode="") {
    const wrapped = `
import sys, io, traceback, json
_stdout = io.StringIO()
_stderr = io.StringIO()
_old_out, _old_err = sys.stdout, sys.stderr
sys.stdout, sys.stderr = _stdout, _stderr
_err = ""
try:
${studentCode.split("\n").map(l=>"    "+l).join("\n")}
${testCode ? testCode.split("\n").map(l=>"    "+l).join("\n") : ""}
except Exception:
    _err = traceback.format_exc()
finally:
    sys.stdout, sys.stderr = _old_out, _old_err
json.dumps({"stdout": _stdout.getvalue(), "stderr": _stderr.getvalue(), "error": _err})
`;
    const jsonText = await pyodide.runPythonAsync(wrapped);
    const obj = JSON.parse(jsonText);
    return {
      stdout: String(obj.stdout||"").replace(/\r\n/g,"\n").trimEnd(),
      stderr: String(obj.stderr||"").replace(/\r\n/g,"\n").trimEnd(),
      error:  String(obj.error ||"").replace(/\r\n/g,"\n").trimEnd()
    };
  }

  async function doRun() {
    outputEl.textContent="Running‚Ä¶";
    const out = await runPythonCapture(editor.value);
    const combined = [out.stdout, out.stderr, out.error].filter(Boolean).join("\n");
    outputEl.textContent = combined || "";
    return out;
  }

  // ---------- Hint Levels ----------
  // 0-1 tries: basic steps
  // 2 tries: extra hint
  // 3+ tries: example template
  function hintBundle(labId, baseSteps, hint2, hint3) {
    const t = getTries(labId);
    if (t >= 3 && hint3) return { steps: baseSteps, hintText: "Example template: " + hint3 };
    if (t >= 2 && hint2) return { steps: baseSteps, hintText: "Hint: " + hint2 };
    return { steps: baseSteps, hintText: null };
  }

  // ---------- LABS ----------
  const labs = [
    {
      id:"lab1",
      title:"Lab 1 ‚Äî print() basics",
      points: 100/6,
      instructions:`<b>Print exactly:</b><pre>Hello, Python!\nYourName</pre>`,
      starter:`# LAB 1\n# 1) Print exactly: Hello, Python!\n# 2) Print your first name on the next line\n\n`,
      validate: async(code)=>{
        const out = await runPythonCapture(code);
        const raw = [out.stdout,out.stderr,out.error].filter(Boolean).join("\n").trimEnd();
        const expected = "Hello, Python!\nYourName";
        const lines = out.stdout.split("\n").filter(l=>l!=="");

        if(out.error){
          const b = hintBundle("lab1",
            ["Use print(...) with parentheses.", "Put text in quotes, like: print(\"Hello, Python!\")", "Fix the error and run again."],
            "If you see NameError, you forgot quotes.",
            "print(\"Hello, Python!\")\nprint(\"Hector\")"
          );
          return {ok:false, expected, got: out.error, title:"Fix the error first", ...b};
        }
        if(lines.length<2){
          const b = hintBundle("lab1",
            ["You need TWO print() statements.", "Line 1 must be exactly: Hello, Python!", "Line 2 must print your first name."],
            "Two print lines. No extra text.",
            "print(\"Hello, Python!\")\nprint(\"Hector\")"
          );
          return {ok:false, expected, got: raw, title:"Missing output lines", ...b};
        }
        if(lines[0] !== "Hello, Python!"){
          const b = hintBundle("lab1",
            ["Check spelling, caps, and punctuation.", "Make sure there are no extra spaces.", "Use: print(\"Hello, Python!\")"],
            "Exact match required.",
            "print(\"Hello, Python!\")"
          );
          return {ok:false, expected:"Hello, Python!", got: lines[0]||"", title:"Line 1 is wrong", ...b};
        }
        if(!lines[1] || lines[1].trim()===""){
          const b = hintBundle("lab1",
            ["Line 2 must print your first name.", "Use quotes: print(\"YourName\")", "Run again."],
            "Example: print(\"Maria\")",
            "print(\"Hector\")"
          );
          return {ok:false, expected:"YourName", got: lines[1]??"", title:"Line 2 is missing", ...b};
        }
        return {ok:true};
      }
    },

    {
      id:"lab2",
      title:"Lab 2 ‚Äî sep and end",
      points: 100/6,
      instructions:`Make output exactly:<pre>My-name-is-Python. Monty-Python.</pre><b>Only edit the first print().</b>`,
      starter:`# LAB 2\n# Make the output exactly:\n# My-name-is-Python. Monty-Python.\n# Only edit the FIRST print()\n\nprint("My", "name", "is", "Python.")\nprint("Monty", "Python.")\n`,
      validate: async(code)=>{
        const out = await runPythonCapture(code);
        const expected = "My-name-is-Python. Monty-Python.";
        const got = out.stdout.trimEnd();

        if(out.error){
          const b = hintBundle("lab2",
            ["Undo changes that broke the syntax.", "Only change the first print line.", "Try sep='-' and end=' ' (space)."],
            "sep joins with -, end adds a trailing space.",
            "print(\"My\",\"name\",\"is\",\"Python.\", sep='-', end=' ')\nprint(\"Monty\",\"Python.\", sep='-')"
          );
          return {ok:false, expected, got: out.error, title:"Fix the error first", ...b};
        }

        if(got !== expected){
          const b = hintBundle("lab2",
            ["Use sep='-' in the first print to make dashes.", "Use end=' ' in the first print so the second print continues on the same line.", "Do not edit the second print."],
            "end=' ' (space) is the key.",
            "print(\"My\",\"name\",\"is\",\"Python.\", sep='-', end=' ')\nprint(\"Monty\",\"Python.\", sep='-')"
          );
          return {ok:false, expected, got, title:"Output formatting is off", ...b};
        }
        return {ok:true};
      }
    },

    {
      id:"lab3",
      title:"Lab 3 ‚Äî escape sequences",
      points: 100/6,
      instructions:`Expected output:<pre>A\nB\nC\n\\</pre>Use \\n and then print one backslash.`,
      starter:`# LAB 3\n# 1) ONE print() for A, B, C using \\n\n# 2) Print ONE backslash character\n\n`,
      validate: async(code)=>{
        const out = await runPythonCapture(code);
        const expected = "A\nB\nC\n\\";
        const got = out.stdout.trimEnd();

        if(out.error){
          const b = hintBundle("lab3",
            ["Fix the syntax error (quotes usually).", "Remember: one backslash in output requires \"\\\\\" in code.", "Try again."],
            "Backslash must be escaped inside quotes.",
            "print(\"A\\nB\\nC\")\nprint(\"\\\\\")"
          );
          return {ok:false, expected, got: out.error, title:"Fix the error first", ...b};
        }

        if(got !== expected){
          const b = hintBundle("lab3",
            ["First print should be: print(\"A\\nB\\nC\")", "Second print should be: print(\"\\\\\")", "No extra blank lines."],
            "Two prints total.",
            "print(\"A\\nB\\nC\")\nprint(\"\\\\\")"
          );
          return {ok:false, expected, got, title:"Escapes are incorrect", ...b};
        }
        return {ok:true};
      }
    }
  ];

  // ---------- UI ----------
  function populateLabSelect(){
    labSelect.innerHTML="";
    for(const lab of labs){
      const opt=document.createElement("option");
      opt.value=lab.id; opt.textContent=lab.title;
      labSelect.appendChild(opt);
    }
  }

  function loadLab(labId){
    currentLabId=labId;
    const lab=labs.find(l=>l.id===labId);
    instructionsEl.innerHTML=lab.instructions;
    editor.value = getSavedCode(labId) || lab.starter;
    outputEl.textContent="";
    resultEl.textContent="Run your code, then press Check.";
    resultEl.className="muted";
    clearHelp();
  }

  editor.addEventListener("input", ()=>{
    if(!currentLabId) return;
    setSavedCode(currentLabId, editor.value);
    autosaveStatus.textContent="Autosave: saved";
    setTimeout(()=>autosaveStatus.textContent="Autosave: on", 600);
  });

  labSelect.addEventListener("change", e=>loadLab(e.target.value));

  loadBtn.addEventListener("click", ()=>{
    const lab=labs.find(l=>l.id===currentLabId);
    editor.value=lab.starter;
    setSavedCode(currentLabId, editor.value);
    resetTries(currentLabId);
    clearHelp();
    resultEl.textContent="Starter loaded. Try again.";
  });

  runBtn.addEventListener("click", doRun);

  checkBtn.addEventListener("click", async()=>{
    const lab=labs.find(l=>l.id===currentLabId);
    const verdict=await lab.validate(editor.value);

    if(verdict.ok){
      resultEl.textContent="‚úÖ PASS";
      resultEl.className="pill ok";
      resetTries(currentLabId);
      clearHelp();
      return;
    }

    incTries(currentLabId);
    resultEl.textContent="‚ùå TRY AGAIN";
    resultEl.className="pill bad";
    setHelp(
      verdict.title || "How to Fix",
      verdict.steps || ["Compare expected vs got."],
      verdict.expected ?? null,
      verdict.got ?? null,
      verdict.hintText ?? null
    );
  });

  function renderScores(summary){
    if(!summary){
      scoreBoard.innerHTML="Click <b>Grade All</b> to calculate.";
      quickTotal.textContent="Total: ‚Äî";
      quickTotal.className="pill";
      return;
    }
    const rows = labs.map(l=>{
      const r=summary.byLab[l.id];
      return `
      <div class="scoreline">
        <div><b>${escapeHtml(l.title)}</b><div class="tiny">${r.passed?"PASS":"NOT YET"}</div></div>
        <div class="mono">${r.earned.toFixed(1)} / ${r.max.toFixed(1)}</div>
      </div>`;
    }).join("");

    scoreBoard.innerHTML=`
      <div class="scoreline"><div><b>Total</b></div><div class="mono"><b>${summary.total.toFixed(1)} / 100.0</b></div></div>
      <div style="margin-top:10px;">${rows}</div>
    `;
    quickTotal.textContent=`Total: ${summary.total.toFixed(1)} / 100`;
    quickTotal.className="pill " + (summary.total>=70 ? "ok":"bad");
  }

  gradeBtn.addEventListener("click", async()=>{
    const s=getStudent();
    if(!s.name || !s.studentId){
      nameInput.value=s.name; idInput.value=s.studentId;
      showModal(); return;
    }
    const pointsEach = 100 / labs.length;
    const byLab = {};
    let total=0;

    for(const lab of labs){
      const code = getSavedCode(lab.id) || "";
      let passed=false;
      if(code.trim()){
        const v=await lab.validate(code);
        passed = !!v.ok;
      }
      const earned = passed ? pointsEach : 0;
      byLab[lab.id]={passed, earned, max:pointsEach};
      total += earned;
    }
    total = Math.round(total*10)/10;
    renderScores({total, byLab});

    // OPTIONAL: send to Google Sheet here
    // (We can wire this to Apps Script after you confirm the labs work)
  });

  // Student modal
  editStudentBtn.addEventListener("click", ()=>{
    const s=getStudent();
    nameInput.value=s.name; idInput.value=s.studentId;
    showModal();
  });
  saveStudentBtn.addEventListener("click", ()=>{
    const name=nameInput.value.trim();
    const sid=idInput.value.trim();
    if(!name || !sid) return alert("Enter Name and Student ID.");
    setStudent(name,sid);
    hideModal();
  });

  clearWorkBtn.addEventListener("click", ()=>{
    if(!confirm("Clear your saved code for ALL labs on this browser?")) return;
    for(const lab of labs){
      localStorage.removeItem(codeKey(lab.id));
      localStorage.removeItem(triesKey(lab.id));
    }
    loadLab(labs[0].id);
    renderScores(null);
    alert("Saved work cleared.");
  });

  // Init
  function init(){
    populateLabSelect();
    loadLab(labs[0].id);
    labSelect.value=labs[0].id;
    renderStudent();
    renderScores(null);

    const s=getStudent();
    if(!s.name || !s.studentId) showModal();
  }

  runBtn.disabled=true; checkBtn.disabled=true; gradeBtn.disabled=true;
  init();
  initPyodide();
</script>
</body>
</html>
